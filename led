#!/bin/bash

# --- Cấu hình ---
BRIGHT_FILE="/sys/class/leds/rgb:kbd_backlight/brightness"
COLOR_FILE="/sys/class/leds/rgb:kbd_backlight/multi_intensity"
CONF_FILE="/etc/kbd_backlight.conf"

# --- Chức năng ---
save_state() {
    echo "LAST_COLOR=\"$1\"" > "$CONF_FILE"
    echo "LAST_BRIGHTNESS=\"$2\"" >> "$CONF_FILE"
}

usage() {
    echo "Tool to control and save/restore backlight state."
    echo ""
    echo "Usage: sudo led <command> [parameters]"
    echo ""
    echo "Command:"
    echo "  on | off                Turn on/off the light."
    echo "  bright <0-255>          Set custom brightness."
    echo "  rgb <r> <g> <b>         Custom RGB color mixing."
    echo "  save                    (System) Save current state."
    echo "  restore                 (System) Restore saved state."
    exit 1
}

# --- Kịch bản chính ---
if [[ $EUID -ne 0 ]]; then
   echo "Error: Please run this script as root (using sudo)."
   exit 1
fi
if [ -z "$1" ]; then usage; fi

COMMAND="$1"
case "$COMMAND" in
    save)
        CURRENT_COLOR=$(cat "$COLOR_FILE")
        CURRENT_BRIGHTNESS=$(cat "$BRIGHT_FILE")
        save_state "$CURRENT_COLOR" "$CURRENT_BRIGHTNESS"
        ;;
    restore)
        if [ -f "$CONF_FILE" ]; then
            source "$CONF_FILE"
            echo "$LAST_COLOR" > "$COLOR_FILE"
            echo "$LAST_BRIGHTNESS" > "$BRIGHT_FILE"
        fi
        ;;
    off)
        echo 0 > "$BRIGHT_FILE"
        save_state "$(cat $COLOR_FILE)" "0"
        echo "Keyboard light turned off and state saved."
        ;;
    on)
        echo 255 > "$BRIGHT_FILE"
        save_state "$(cat $COLOR_FILE)" "255"
        echo "Keyboard light turned on and state saved."
        ;;
    bright)
        VALUE="$2"
        if ! [[ "$VALUE" =~ ^[0-9]+$ ]] || [ "$VALUE" -lt 0 ] || [ "$VALUE" -gt 255 ]; then exit 1; fi
        echo "$VALUE" > "$BRIGHT_FILE"
        save_state "$(cat $COLOR_FILE)" "$VALUE"
        echo "Set brightness to $VALUE and saved state."
        ;;
    rgb)
        R="$2"; G="$3"; B="$4"
        if [ -z "$R" ] || [ -z "$G" ] || [ -z "$B" ]; then usage; fi
        for val in $R $G $B; do
            if ! [[ "$val" =~ ^[0-9]+$ ]] || [ "$val" -lt 0 ] || [ "$val" -gt 255 ]; then exit 1; fi
        done
        COLOR_VALUE="$R $G $B"
        echo "$COLOR_VALUE" > "$COLOR_FILE" && echo 255 > "$BRIGHT_FILE"
        save_state "$COLOR_VALUE" "255"
        echo "Set RGB color to ($COLOR_VALUE) and saved state."
        ;;
    *)
        usage
        ;;
esac
exit 0

